<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Framd</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0d0d0d;
            --sidebar-bg: #111111;
            --text: #ffd60a;
            --text-dim: rgba(255, 214, 10, 0.6);
            --text-faint: rgba(255, 214, 10, 0.25);
            --border: rgba(255, 214, 10, 0.12);
            --card-bg: #1a1a1a;
            --gold: #ffd60a;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-faint); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .brand {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .new-video-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            margin-top: 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .new-video-btn:hover {
            background: rgba(255, 214, 10, 0.08);
            border-color: var(--text-dim);
        }
        
        .new-video-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .sidebar-section {
            margin-bottom: 20px;
        }
        
        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-faint);
            padding: 8px 8px 6px;
        }
        
        .project-card {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            margin-bottom: 4px;
        }
        
        .project-card:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .project-card.active {
            background: rgba(255, 214, 10, 0.1);
        }
        
        .project-thumb {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: var(--card-bg);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 14px;
        }
        
        .project-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .project-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .project-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-meta {
            font-size: 11px;
            color: var(--text-faint);
        }
        
        .auto-gen-section {
            padding: 12px;
            background: rgba(255, 214, 10, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin: 12px;
        }
        
        .auto-gen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .auto-gen-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .auto-gen-progress {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .auto-gen-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .auto-gen-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .auto-gen-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 500;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .auto-gen-btn.unlocked {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--bg);
            cursor: pointer;
            opacity: 1;
        }
        
        .auto-gen-btn.unlocked:hover {
            background: #e6c109;
        }
        
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .user-menu:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--bg);
        }
        
        .user-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .main-header {
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .project-title-display {
            font-size: 14px;
            color: var(--text-dim);
            font-weight: 500;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .token-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gold);
        }
        
        .dev-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .dev-toggle-switch {
            width: 32px;
            height: 18px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 9px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .dev-toggle-switch.on {
            background: var(--gold);
        }
        
        .dev-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .dev-toggle-switch.on::after {
            transform: translateX(14px);
        }
        
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .chat-welcome {
            max-width: 680px;
            margin: 0 auto;
            padding: 60px 20px;
            text-align: center;
        }
        
        .chat-welcome h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .chat-welcome p {
            color: var(--text-dim);
            font-size: 15px;
            margin-bottom: 40px;
        }
        
        .mode-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 40px;
        }
        
        .mode-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .mode-card:hover {
            border-color: var(--text-dim);
            transform: translateY(-2px);
        }
        
        .mode-card.selected {
            border-color: var(--gold);
            background: rgba(255, 214, 10, 0.08);
        }
        
        .mode-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            color: var(--gold);
        }
        
        .mode-name {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .mode-price {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .chat-messages {
            max-width: 720px;
            margin: 0 auto;
            display: none;
        }
        
        .chat-messages.active {
            display: block;
        }
        
        .message {
            margin-bottom: 24px;
        }
        
        .message-user {
            display: flex;
            justify-content: flex-end;
        }
        
        .message-user .message-content {
            background: rgba(255, 214, 10, 0.15);
            border-radius: 16px 16px 4px 16px;
            padding: 12px 16px;
            max-width: 80%;
        }
        
        .message-ai {
            display: flex;
            gap: 12px;
        }
        
        .message-ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message-ai .message-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .chat-input-area {
            padding: 16px 24px 24px;
            border-top: 1px solid var(--border);
        }
        
        .chat-input-container {
            max-width: 720px;
            margin: 0 auto;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            padding: 14px 50px 14px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chat-input:focus {
            border-color: var(--text-dim);
        }
        
        .chat-input::placeholder {
            color: var(--text-faint);
        }
        
        .chat-send-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            background: var(--gold);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg);
            transition: background 0.15s;
        }
        
        .chat-send-btn:hover {
            background: #e6c109;
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .processing-banner {
            display: none;
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        
        .processing-banner.active {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .processing-progress {
            flex: 1;
        }
        
        .processing-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .processing-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .processing-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .processing-text {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 6px;
        }
        
        .processing-actions {
            display: flex;
            gap: 8px;
        }
        
        .processing-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .processing-btn-primary {
            background: var(--gold);
            border: none;
            color: var(--bg);
        }
        
        .processing-btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .mode-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="brand">Framd</div>
                <button class="new-video-btn" onclick="startNewProject()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Video
                </button>
            </div>
            
            <div class="sidebar-content">
                <div class="sidebar-section" id="today-projects">
                    <div class="sidebar-section-title">Today</div>
                    <div id="today-list"></div>
                </div>
                
                <div class="sidebar-section" id="yesterday-projects">
                    <div class="sidebar-section-title">Yesterday</div>
                    <div id="yesterday-list"></div>
                </div>
                
                <div class="sidebar-section" id="older-projects">
                    <div class="sidebar-section-title">Previous 7 Days</div>
                    <div id="older-list"></div>
                </div>
            </div>
            
            <div class="auto-gen-section">
                <div class="auto-gen-header">
                    <span class="auto-gen-title">Auto Generator</span>
                    <span class="auto-gen-progress" id="auto-gen-count">0/5</span>
                </div>
                <div class="auto-gen-bar">
                    <div class="auto-gen-fill" id="auto-gen-bar" style="width: 0%"></div>
                </div>
                <button class="auto-gen-btn" id="auto-gen-btn" onclick="openAutoGenerator()">
                    <span id="auto-gen-btn-text">LOCKED</span>
                </button>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="user-avatar">{{ user_initials }}</div>
                    <div class="user-name">{{ user_name }}</div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="main-header">
                <div class="project-title-display" id="current-project-title"></div>
                <div class="header-actions">
                    <div class="token-pill">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <span id="token-balance">{{ token_balance }}</span>
                    </div>
                    <div class="dev-toggle">
                        <span>System</span>
                        <div class="dev-toggle-switch on" id="dev-toggle" onclick="toggleDevMode()"></div>
                    </div>
                </div>
            </header>
            
            <div class="chat-area" id="chat-area">
                <div class="processing-banner" id="processing-banner">
                    <div class="processing-progress">
                        <div class="processing-title">Your video is being created</div>
                        <div class="processing-bar">
                            <div class="processing-fill" id="processing-fill" style="width: 0%"></div>
                        </div>
                        <div class="processing-text" id="processing-text">Processing scenes...</div>
                    </div>
                    <div class="processing-actions">
                        <button class="processing-btn processing-btn-secondary" onclick="closeAndNotify()">Close and notify me</button>
                        <button class="processing-btn processing-btn-primary" onclick="keepWatching()">Keep watching</button>
                    </div>
                </div>
                
                <div class="chat-welcome" id="chat-welcome">
                    <h1>What kind of video do you want?</h1>
                    <p>Choose a mode or just describe what you want to create</p>
                    
                    <div class="mode-cards">
                        <div class="mode-card" onclick="selectMode('remix')">
                            <div class="mode-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M21 12a9 9 0 11-9-9"></path>
                                    <path d="M21 3v6h-6"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </div>
                            <div class="mode-name">Remix</div>
                            <div class="mode-price">$0.17/sec</div>
                        </div>
                        
                        <div class="mode-card" onclick="selectMode('clipper')">
                            <div class="mode-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="6" cy="6" r="3"></circle>
                                    <circle cx="6" cy="18" r="3"></circle>
                                    <line x1="20" y1="4" x2="8.12" y2="15.88"></line>
                                    <line x1="14.47" y1="14.48" x2="20" y2="20"></line>
                                    <line x1="8.12" y1="8.12" x2="12" y2="12"></line>
                                </svg>
                            </div>
                            <div class="mode-name">Clipper</div>
                            <div class="mode-price">$0.22 - $0.37</div>
                        </div>
                        
                        <div class="mode-card" onclick="selectMode('simple')">
                            <div class="mode-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="2" y="2" width="20" height="20" rx="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <path d="M21 15l-5-5L5 21"></path>
                                </svg>
                            </div>
                            <div class="mode-name">Simple Stock</div>
                            <div class="mode-price">$0.033/sec</div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages"></div>
            </div>
            
            <div class="chat-input-area">
                <div class="chat-input-container">
                    <textarea 
                        class="chat-input" 
                        id="chat-input"
                        placeholder="Describe what you want to create..."
                        rows="1"
                        onkeydown="handleInputKeydown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="chat-send-btn" id="send-btn" onclick="sendMessage()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const state = {
            currentProjectId: null,
            currentMode: null,
            messages: [],
            projects: [],
            exportCount: {{ export_count }},
            devModeOn: true,
            isProcessing: false
        };
        
        function startNewProject() {
            state.currentProjectId = null;
            state.currentMode = null;
            state.messages = [];
            document.getElementById('current-project-title').textContent = '';
            document.getElementById('chat-welcome').style.display = 'block';
            document.getElementById('chat-messages').classList.remove('active');
            document.getElementById('chat-messages').innerHTML = '';
            document.querySelectorAll('.project-card').forEach(c => c.classList.remove('active'));
        }
        
        function selectMode(mode) {
            state.currentMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            const modeNames = {
                remix: 'Remix Mode',
                clipper: 'Clipper Mode',
                simple: 'Simple Stock Mode'
            };
            
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('chat-messages').classList.add('active');
            
            const modeDescriptions = {
                remix: "You selected Remix mode. Upload a reference video and tell me what content you want. I'll preserve the motion and structure while transforming the visuals.",
                clipper: "You selected Clipper mode. Share a long video or transcript and I'll extract the best moments to create professional clips.",
                simple: "You selected Simple Stock mode. Tell me your topic or script and I'll create a video using stock footage and AI-generated visuals."
            };
            
            addAIMessage(modeDescriptions[mode] + "\n\nWhat would you like to create?");
        }
        
        function selectProject(projectId) {
            state.currentProjectId = projectId;
            document.querySelectorAll('.project-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-project-id="${projectId}"]`)?.classList.add('active');
            
            loadProjectChat(projectId);
        }
        
        async function loadProjectChat(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}/chat`);
                const data = await response.json();
                
                if (data.ok) {
                    state.messages = data.messages || [];
                    state.currentMode = data.mode;
                    document.getElementById('current-project-title').textContent = data.name;
                    document.getElementById('chat-welcome').style.display = 'none';
                    document.getElementById('chat-messages').classList.add('active');
                    renderMessages();
                }
            } catch (err) {
                console.error('Failed to load project chat:', err);
            }
        }
        
        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = state.messages.map(msg => {
                if (msg.role === 'user') {
                    return `<div class="message message-user">
                        <div class="message-content">
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>`;
                } else {
                    return `<div class="message message-ai">
                        <div class="message-ai-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0d0d0d" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        </div>
                        <div class="message-content">
                            <div class="message-text">${formatAIMessage(msg.content)}</div>
                        </div>
                    </div>`;
                }
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatAIMessage(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }
        
        function addUserMessage(text) {
            state.messages.push({ role: 'user', content: text });
            renderMessages();
        }
        
        function addAIMessage(text) {
            state.messages.push({ role: 'assistant', content: text });
            renderMessages();
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            input.value = '';
            autoResize(input);
            
            addUserMessage(text);
            
            if (!state.currentMode && !state.currentProjectId) {
                document.getElementById('chat-welcome').style.display = 'none';
                document.getElementById('chat-messages').classList.add('active');
                state.currentMode = 'auto';
            }
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        project_id: state.currentProjectId,
                        mode: state.currentMode
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    if (data.project_id && !state.currentProjectId) {
                        state.currentProjectId = data.project_id;
                        document.getElementById('current-project-title').textContent = data.project_name || 'New Project';
                        loadProjects();
                    }
                    
                    if (data.response) {
                        addAIMessage(data.response);
                    }
                    
                    if (data.needs_clarification) {
                        addAIMessage(data.clarification_question);
                    }
                    
                    if (data.processing) {
                        showProcessingBanner(data.job_id);
                    }
                } else {
                    addAIMessage("I encountered an issue. " + (data.error || "Please try again."));
                }
            } catch (err) {
                addAIMessage("Connection error. Please check your network and try again.");
            }
        }
        
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
        
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                if (data.ok) {
                    state.projects = data.projects || [];
                    renderProjects();
                    updateAutoGenStatus();
                }
            } catch (err) {
                console.error('Failed to load projects:', err);
            }
        }
        
        function renderProjects() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const todayProjects = [];
            const yesterdayProjects = [];
            const olderProjects = [];
            
            state.projects.forEach(project => {
                const projectDate = new Date(project.created_at);
                projectDate.setHours(0, 0, 0, 0);
                
                if (projectDate >= today) {
                    todayProjects.push(project);
                } else if (projectDate >= yesterday) {
                    yesterdayProjects.push(project);
                } else if (projectDate >= weekAgo) {
                    olderProjects.push(project);
                }
            });
            
            document.getElementById('today-list').innerHTML = renderProjectList(todayProjects);
            document.getElementById('yesterday-list').innerHTML = renderProjectList(yesterdayProjects);
            document.getElementById('older-list').innerHTML = renderProjectList(olderProjects);
            
            document.getElementById('today-projects').style.display = todayProjects.length ? 'block' : 'none';
            document.getElementById('yesterday-projects').style.display = yesterdayProjects.length ? 'block' : 'none';
            document.getElementById('older-projects').style.display = olderProjects.length ? 'block' : 'none';
        }
        
        function renderProjectList(projects) {
            return projects.map(p => `
                <div class="project-card ${state.currentProjectId === p.id ? 'active' : ''}" 
                     data-project-id="${p.id}"
                     onclick="selectProject(${p.id})">
                    <div class="project-thumb">
                        ${p.thumbnail ? `<img src="${p.thumbnail}" alt="">` : p.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="project-info">
                        <div class="project-name">${escapeHtml(p.name)}</div>
                        <div class="project-meta">${p.duration || '0'}s â€¢ ${p.mode || 'Draft'}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateAutoGenStatus() {
            const count = state.exportCount;
            const unlocked = count >= 5;
            
            document.getElementById('auto-gen-count').textContent = `${Math.min(count, 5)}/5`;
            document.getElementById('auto-gen-bar').style.width = `${Math.min(count, 5) * 20}%`;
            
            const btn = document.getElementById('auto-gen-btn');
            const btnText = document.getElementById('auto-gen-btn-text');
            
            if (unlocked) {
                btn.classList.add('unlocked');
                btnText.textContent = 'CHECK PREVIEWS';
            } else {
                btn.classList.remove('unlocked');
                btnText.textContent = 'LOCKED';
            }
        }
        
        function openAutoGenerator() {
            if (state.exportCount >= 5) {
                window.location.href = '/auto-generator';
            }
        }
        
        function toggleDevMode() {
            state.devModeOn = !state.devModeOn;
            document.getElementById('dev-toggle').classList.toggle('on', state.devModeOn);
            
            fetch('/api/dev-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: state.devModeOn })
            });
        }
        
        function showProcessingBanner(jobId) {
            state.isProcessing = true;
            document.getElementById('processing-banner').classList.add('active');
            pollJobStatus(jobId);
        }
        
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/job/${jobId}/status`);
                const data = await response.json();
                
                if (data.status === 'complete') {
                    document.getElementById('processing-banner').classList.remove('active');
                    state.isProcessing = false;
                    addAIMessage("Your video is ready! You can preview it now or export the final version.");
                } else if (data.status === 'error') {
                    document.getElementById('processing-banner').classList.remove('active');
                    state.isProcessing = false;
                    addAIMessage("There was an issue creating your video. Let me try a different approach.");
                } else {
                    document.getElementById('processing-fill').style.width = `${data.progress || 0}%`;
                    document.getElementById('processing-text').textContent = data.message || 'Processing...';
                    setTimeout(() => pollJobStatus(jobId), 2000);
                }
            } catch (err) {
                console.error('Failed to poll job status:', err);
            }
        }
        
        function closeAndNotify() {
            addAIMessage("I'll email you when your video is ready. You can close this tab now.");
            document.getElementById('processing-banner').classList.remove('active');
        }
        
        function keepWatching() {
            document.getElementById('processing-banner').classList.remove('active');
        }
        
        function toggleUserMenu() {
            window.location.href = '/settings';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            updateAutoGenStatus();
        });
    </script>
</body>
</html>
