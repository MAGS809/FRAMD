<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Framd</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --bg: #0d0d0d;
            --sidebar-bg: #111111;
            --text: #ffd60a;
            --text-dim: rgba(255, 214, 10, 0.6);
            --text-faint: rgba(255, 214, 10, 0.25);
            --border: rgba(255, 214, 10, 0.12);
            --card-bg: #1a1a1a;
            --gold: #ffd60a;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--text-faint); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-dim); }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 260px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease, width 0.3s ease;
            z-index: 100;
        }
        
        .sidebar-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        
        .sidebar-toggle:hover {
            background: rgba(255, 214, 10, 0.08);
            border-color: var(--text-dim);
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 99;
        }
        
        .sidebar-overlay.active {
            display: block;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .brand {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }
        
        .new-video-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            margin-top: 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .new-video-btn:hover {
            background: rgba(255, 214, 10, 0.08);
            border-color: var(--text-dim);
        }
        
        .new-video-btn svg {
            width: 18px;
            height: 18px;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .sidebar-section {
            margin-bottom: 20px;
        }
        
        .sidebar-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-faint);
            padding: 8px 8px 6px;
        }
        
        .project-card {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            margin-bottom: 4px;
            position: relative;
        }
        
        .project-generating-spinner {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-faint);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translateY(-50%) rotate(360deg); }
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            animation: slideIn 0.3s ease;
            max-width: 360px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .toast-icon svg {
            width: 18px;
            height: 18px;
            color: #0d0d0d;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }
        
        .toast-message {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .toast-action {
            padding: 6px 12px;
            background: var(--gold);
            color: #0d0d0d;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        
        .toast-action:hover {
            opacity: 0.9;
        }
        
        .toast-close {
            padding: 4px;
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            opacity: 0.6;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        .progress-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            min-width: 240px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
        }
        
        .progress-panel.active {
            display: block;
        }
        
        .progress-panel-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 10px;
        }
        
        .progress-bar-container {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            height: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-bar-fill {
            height: 100%;
            background: var(--gold);
            transition: width 0.3s ease;
        }
        
        .progress-status {
            font-size: 12px;
            color: var(--text-dim);
        }
        
        .project-card:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .project-card.active {
            background: rgba(255, 214, 10, 0.1);
        }
        
        .project-thumb {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: var(--card-bg);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            font-size: 14px;
        }
        
        .project-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .project-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .project-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .project-meta {
            font-size: 11px;
            color: var(--text-faint);
        }
        
        .auto-gen-section {
            padding: 12px;
            background: rgba(255, 214, 10, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin: 12px;
        }
        
        .auto-gen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .auto-gen-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .auto-gen-progress {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .auto-gen-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .auto-gen-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .auto-gen-btn {
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-dim);
            font-size: 12px;
            font-weight: 500;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .auto-gen-btn.unlocked {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--bg);
            cursor: pointer;
            opacity: 1;
        }
        
        .auto-gen-btn.unlocked:hover {
            background: #e6c109;
        }
        
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--border);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .user-menu:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--bg);
        }
        
        .user-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .main-header {
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        
        .project-title-display {
            font-size: 14px;
            color: var(--text-dim);
            font-weight: 500;
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .token-pill {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--gold);
        }
        
        .token-add {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--gold);
            color: var(--bg);
            border-radius: 50%;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 4px;
            transition: transform 0.15s;
        }
        
        .token-add:hover {
            transform: scale(1.1);
        }
        
        .project-name-edit {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .project-name-edit:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        
        .project-name-text {
            font-size: 13px;
            color: var(--text);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .project-name-icon {
            color: var(--text-dim);
            opacity: 0.6;
        }
        
        .project-name-input {
            background: transparent;
            border: none;
            outline: none;
            font-size: 13px;
            color: var(--text);
            font-family: inherit;
            width: 180px;
        }
        
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        .chat-welcome {
            max-width: 680px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 120px);
        }
        
        .chat-welcome h1 {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .chat-welcome p {
            color: var(--text-dim);
            font-size: 15px;
            margin-bottom: 24px;
        }

        .brief-input-section {
            max-width: 600px;
            width: 100%;
            margin: 0 auto 32px;
        }

        .brief-input-wrapper {
            position: relative;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 4px;
            transition: border-color 0.2s;
        }

        .brief-input-wrapper:focus-within {
            border-color: var(--gold);
        }

        .brief-textarea {
            width: 100%;
            min-height: 80px;
            max-height: 160px;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            line-height: 1.5;
            padding: 14px 16px 8px;
            resize: none;
            outline: none;
        }

        .brief-textarea::placeholder {
            color: var(--text-faint);
        }

        .brief-bottom-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 8px 8px 12px;
        }

        .brief-upload-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 13px;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .brief-upload-btn:hover {
            color: var(--gold);
            border-color: var(--text-dim);
        }

        .brief-upload-btn svg {
            width: 16px;
            height: 16px;
        }

        .brief-go-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gold);
            border: none;
            color: #0d0d0d;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .brief-go-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 16px rgba(255, 214, 10, 0.3);
        }

        .brief-go-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .brief-go-btn svg {
            width: 18px;
            height: 18px;
        }

        .uploaded-files-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 12px 4px;
        }

        .uploaded-file-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 214, 10, 0.08);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 12px;
            color: var(--text-dim);
        }

        .uploaded-file-chip .file-mode-toggle {
            display: flex;
            gap: 2px;
            margin-left: 4px;
        }

        .file-mode-btn {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-faint);
            cursor: pointer;
            transition: all 0.15s;
        }

        .file-mode-btn.active {
            background: var(--gold);
            color: #0d0d0d;
            border-color: var(--gold);
            font-weight: 600;
        }

        .file-mode-btn:hover:not(.active) {
            border-color: var(--text-dim);
            color: var(--text-dim);
        }

        .file-remove-btn {
            background: none;
            border: none;
            color: var(--text-faint);
            cursor: pointer;
            font-size: 14px;
            padding: 0 2px;
            line-height: 1;
        }

        .file-remove-btn:hover {
            color: var(--gold);
        }

        .presets-section {
            margin-top: 8px;
        }

        .presets-label {
            font-size: 12px;
            color: var(--text-faint);
            margin-bottom: 10px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .mode-cards {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 40px;
        }
        
        .mode-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            flex: 0 1 auto;
            min-width: 120px;
        }
        
        .mode-card:hover {
            border-color: var(--text-dim);
            transform: translateY(-1px);
        }
        
        .mode-card.selected {
            border-color: var(--gold);
            background: rgba(255, 214, 10, 0.08);
        }
        
        .mode-icon {
            width: 28px;
            height: 28px;
            margin: 0 auto 6px;
            color: var(--gold);
        }
        
        .mode-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .mode-desc {
            display: none;
        }
        
        .mode-price {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-dim);
        }
        
        .mode-price-detail {
            font-size: 10px;
            font-weight: 400;
            color: var(--text-faint);
        }
        
        .mode-price-sub {
            font-size: 9px;
            color: var(--text-faint);
            margin-top: 2px;
            font-weight: 400;
        }

        .overlay-panel {
            display: none;
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin: 12px 16px;
        }
        .overlay-panel.active { display: block; }
        .overlay-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }
        .overlay-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        .overlay-panel-close {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }
        .overlay-elements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }
        .overlay-element-card {
            padding: 12px 10px;
            background: rgba(255, 214, 10, 0.04);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all var(--transition-fast);
        }
        .overlay-element-card:hover {
            border-color: var(--gold);
            background: rgba(255, 214, 10, 0.08);
        }
        .overlay-element-card.selected {
            border-color: var(--gold);
            background: rgba(255, 214, 10, 0.12);
        }
        .overlay-element-icon {
            font-size: 20px;
            margin-bottom: 4px;
            color: var(--gold);
        }
        .overlay-element-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text);
        }
        .overlay-element-cost {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 2px;
        }
        .overlay-templates-section {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }
        .overlay-templates-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .overlay-template-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .overlay-template-chip {
            padding: 5px 12px;
            background: rgba(255, 214, 10, 0.06);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 11px;
            color: var(--text);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .overlay-template-chip:hover {
            border-color: var(--gold);
            background: rgba(255, 214, 10, 0.12);
        }
        .overlay-template-chip .chip-count {
            color: var(--text-dim);
            margin-left: 4px;
            font-size: 10px;
        }
        .overlay-price-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 14px;
            padding: 10px 12px;
            background: rgba(255, 214, 10, 0.06);
            border-radius: 8px;
        }
        .overlay-price-label {
            font-size: 12px;
            color: var(--text-dim);
        }
        .overlay-price-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--gold);
        }
        .overlay-price-value.free {
            color: #4ade80;
        }
        .overlay-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .overlay-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
            transition: all var(--transition-fast);
        }
        .overlay-btn:hover { border-color: var(--gold); }
        .overlay-btn-primary {
            background: var(--gold);
            color: #000;
            border-color: var(--gold);
        }
        .overlay-btn-primary:hover { opacity: 0.9; }
        .usage-bar {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(255, 214, 10, 0.04);
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-dim);
        }
        .usage-progress {
            height: 3px;
            background: rgba(255, 214, 10, 0.15);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }
        .usage-progress-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .quality-selector {
            margin-top: 16px;
            padding: 16px;
            background: rgba(255, 214, 10, 0.05);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        
        .quality-selector-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
        }
        
        .quality-cards {
            display: flex;
            gap: 12px;
        }
        
        .quality-card {
            flex: 1;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .quality-card:hover {
            border-color: var(--text-dim);
            background: rgba(255, 214, 10, 0.08);
        }
        
        .quality-card.selected {
            border-color: var(--gold);
            background: rgba(255, 214, 10, 0.12);
        }
        
        .quality-tier-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        
        .quality-tier-model {
            font-size: 11px;
            color: var(--text-faint);
            margin-bottom: 8px;
        }
        
        .quality-tier-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--gold);
        }
        
        .quality-tier-unit {
            font-size: 11px;
            color: var(--text-dim);
        }
        
        .quality-tier-desc {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 8px;
            line-height: 1.4;
        }
        
        .quality-disclaimer {
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(255, 214, 10, 0.03);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-dim);
            line-height: 1.5;
        }
        
        .scene-plan-card {
            background: rgba(255, 214, 10, 0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }
        .scene-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .scene-plan-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
        }
        .scene-plan-count {
            font-size: 11px;
            color: var(--text-dim);
        }
        .scene-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .scene-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 214, 10, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 214, 10, 0.06);
        }
        .scene-index {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 214, 10, 0.12);
            color: var(--gold);
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .scene-details {
            flex: 1;
            min-width: 0;
        }
        .scene-text {
            font-size: 12px;
            color: var(--text);
            line-height: 1.4;
            margin-bottom: 4px;
        }
        .scene-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .scene-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255, 214, 10, 0.08);
            color: var(--text-dim);
        }
        .scene-tag.source-clip { border-left: 2px solid #4ade80; }
        .scene-tag.source-stock { border-left: 2px solid #60a5fa; }
        .scene-tag.source-dalle { border-left: 2px solid #c084fc; }
        .scene-tag.source-remix { border-left: 2px solid #fb923c; }
        .scene-cost {
            font-size: 11px;
            color: var(--text-dim);
            flex-shrink: 0;
        }
        .cost-summary {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .cost-total {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 18px;
            font-weight: 600;
            color: var(--gold);
        }
        .cost-breakdown {
            font-size: 11px;
            color: var(--text-dim);
        }
        .approve-btn {
            padding: 10px 24px;
            background: var(--gold);
            color: #0d0d0d;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .approve-btn:hover {
            background: #e6c109;
            transform: translateY(-1px);
        }
        .revise-btn {
            padding: 10px 24px;
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
            margin-right: 8px;
        }
        .revise-btn:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }
        .watermark-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            background: rgba(255, 214, 10, 0.1);
            color: var(--text-dim);
            letter-spacing: 0.3px;
        }
        .quality-cost-estimate {
            margin-top: 12px;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cost-label {
            font-size: 13px;
            color: var(--text-dim);
        }
        
        .cost-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--gold);
        }
        
        .chat-messages {
            max-width: 720px;
            margin: 0 auto;
            display: none;
        }
        
        .chat-messages.active {
            display: block;
        }
        
        .message {
            margin-bottom: 24px;
        }
        
        .message-user {
            display: flex;
            justify-content: flex-end;
        }
        
        .message-user .message-content {
            background: rgba(255, 214, 10, 0.15);
            border-radius: 16px 16px 4px 16px;
            padding: 12px 16px;
            max-width: 80%;
        }
        
        .message-ai {
            display: flex;
            gap: 12px;
        }
        
        .message-ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .message-ai .message-content {
            flex: 1;
            min-width: 0;
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .chat-input-area {
            padding: 12px 20px 20px;
        }
        
        .chat-input-container {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 24px;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
            min-height: 48px;
            max-height: 200px;
        }
        
        .chat-input:focus {
            border-color: var(--gold);
        }
        
        .chat-input::placeholder {
            color: var(--text-faint);
        }
        
        .chat-send-btn {
            width: 48px;
            height: 48px;
            background: var(--gold);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            flex-shrink: 0;
            align-items: center;
            justify-content: center;
            color: var(--bg);
            transition: background 0.15s;
        }
        
        .chat-send-btn:hover {
            background: #e6c109;
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
        }
        
        /* Drag and drop overlay */
        .dropzone-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 31, 20, 0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .dropzone-overlay.active {
            display: flex;
        }
        
        .dropzone-content {
            text-align: center;
            color: var(--gold);
        }
        
        .dropzone-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.8;
        }
        
        .dropzone-text {
            font-size: 20px;
            font-weight: 500;
        }
        
        .dropzone-subtext {
            font-size: 14px;
            color: var(--text-dim);
            margin-top: 8px;
            cursor: not-allowed;
        }
        
        .processing-banner {
            display: none;
            background: rgba(255, 214, 10, 0.1);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        
        .processing-banner.active {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .processing-progress {
            flex: 1;
        }
        
        .processing-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
        }
        
        .processing-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .processing-fill {
            height: 100%;
            background: var(--gold);
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .processing-text {
            font-size: 12px;
            color: var(--text-dim);
            margin-top: 6px;
        }
        
        .processing-actions {
            display: flex;
            gap: 8px;
        }
        
        .processing-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .processing-btn-primary {
            background: var(--gold);
            border: none;
            color: var(--bg);
        }
        
        .processing-btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .mode-cards {
                flex-wrap: wrap;
            }
            
            .brief-input-section {
                max-width: 100%;
            }
            
            .main-header {
                padding-left: 12px;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar.collapsed {
                width: 0;
                overflow: hidden;
                border-right: none;
            }
            
            .sidebar.collapsed * {
                opacity: 0;
                pointer-events: none;
            }
        }
    </style>
</head>
<body>
<div class="toast-container" id="toast-container"></div>
    <!-- Dropzone overlay for file drag and drop -->
    <div class="dropzone-overlay" id="dropzone-overlay">
        <div class="dropzone-content">
            <svg class="dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <div class="dropzone-text">Drop your file here</div>
            <div class="dropzone-subtext">Video, audio, or image files</div>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand">Framd</div>
                <button class="new-video-btn" onclick="startNewProject()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Video
                </button>
            </div>
            
            <div class="sidebar-content">
                <div class="sidebar-section" id="today-projects">
                    <div class="sidebar-section-title">Today</div>
                    <div id="today-list"></div>
                </div>
                
                <div class="sidebar-section" id="yesterday-projects">
                    <div class="sidebar-section-title">Yesterday</div>
                    <div id="yesterday-list"></div>
                </div>
                
                <div class="sidebar-section" id="older-projects">
                    <div class="sidebar-section-title">Previous 7 Days</div>
                    <div id="older-list"></div>
                </div>
            </div>
            
            <div class="auto-gen-section">
                <div class="auto-gen-header">
                    <span class="auto-gen-title">Auto Generator</span>
                    <span class="auto-gen-progress" id="auto-gen-count">0/5</span>
                </div>
                <div class="auto-gen-bar">
                    <div class="auto-gen-fill" id="auto-gen-bar" style="width: 0%"></div>
                </div>
                <button class="auto-gen-btn" id="auto-gen-btn" onclick="openAutoGenerator()">
                    <span id="auto-gen-btn-text">LOCKED</span>
                </button>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-menu" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="user-avatar">{{ user_initials }}</div>
                    <div class="user-name">{{ user_name }}</div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <header class="main-header">
                <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="project-title-display" id="current-project-title"></div>
                <div class="header-actions">
                    <div class="project-name-edit" id="project-name-edit" onclick="startProjectRename()">
                        <span class="project-name-text" id="project-name-text">Untitled Project</span>
                        <svg class="project-name-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </div>
                    <div class="token-pill">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <span id="token-balance">{{ token_balance }}</span>
                        <a href="/billing" class="token-add" title="Get more tokens">+</a>
                    </div>
                </div>
            </header>
            
            <div class="chat-area" id="chat-area">
                <div class="processing-banner" id="processing-banner">
                    <div class="processing-progress">
                        <div class="processing-title">Your video is being created</div>
                        <div class="processing-bar">
                            <div class="processing-fill" id="processing-fill" style="width: 0%"></div>
                        </div>
                        <div class="processing-text" id="processing-text">Processing scenes...</div>
                    </div>
                    <div class="processing-actions">
                        <button class="processing-btn processing-btn-secondary" onclick="closeAndNotify()">Close and notify me</button>
                        <button class="processing-btn processing-btn-primary" onclick="keepWatching()">Keep watching</button>
                    </div>
                </div>
                
                <div class="chat-welcome" id="chat-welcome">
                    <h1>What do you want to make?</h1>
                    <p>Describe your video and upload clips, or just start with an idea</p>
                    
                    <div class="brief-input-section">
                        <div class="brief-input-wrapper">
                            <textarea class="brief-textarea" id="brief-textarea" placeholder="A 30-second video about... / Clip the best moments from my podcast / A hype reel for my brand..." oninput="updateBriefGoBtn()"></textarea>
                            <div class="uploaded-files-preview" id="uploaded-files-preview" style="display:none;"></div>
                            <div class="brief-bottom-row">
                                <button class="brief-upload-btn" onclick="document.getElementById('brief-file-input').click()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    Upload videos
                                </button>
                                <input type="file" id="brief-file-input" accept="video/*" multiple style="display:none;" onchange="handleBriefFileUpload(event)">
                                <button class="brief-go-btn" id="brief-go-btn" disabled onclick="submitBrief()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                        <polyline points="12 5 19 12 12 19"></polyline>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
                
                <div class="chat-messages" id="chat-messages"></div>
            </div>

            <div class="overlay-panel" id="overlay-panel">
                <div class="overlay-panel-header">
                    <div class="overlay-panel-title">Add Overlays</div>
                    <button class="overlay-panel-close" onclick="toggleOverlayPanel()">&times;</button>
                </div>
                <div class="overlay-elements-grid" id="overlay-elements-grid"></div>
                <div class="overlay-templates-section" id="overlay-templates-section" style="display:none;">
                    <div class="overlay-templates-label">Saved Templates</div>
                    <div class="overlay-template-chips" id="saved-template-chips"></div>
                </div>
                <div class="overlay-templates-section" id="overlay-recent-section" style="display:none;">
                    <div class="overlay-templates-label">Recent Overlays</div>
                    <div class="overlay-template-chips" id="recent-template-chips"></div>
                </div>
                <div class="overlay-price-bar">
                    <span class="overlay-price-label">Estimated cost</span>
                    <span class="overlay-price-value" id="overlay-price">$0.49</span>
                </div>
                <div class="usage-bar" id="usage-bar" style="display:none;">
                    <span id="usage-text"></span>
                    <div class="usage-progress">
                        <div class="usage-progress-fill" id="usage-progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="overlay-actions">
                    <button class="overlay-btn" onclick="saveOverlayTemplate()">Save as Template</button>
                    <button class="overlay-btn" onclick="promoteOverlayTemplate()">Save Permanently</button>
                    <button class="overlay-btn overlay-btn-primary" onclick="applyOverlays()">Apply Overlays</button>
                </div>
            </div>

            <div class="chat-input-area" id="chat-input-area" style="display: none;">
                <div class="chat-input-container">
                    <textarea 
                        class="chat-input" 
                        id="chat-input"
                        placeholder="Describe what you want to create..."
                        rows="1"
                        onkeydown="handleInputKeydown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="chat-send-btn" id="send-btn" onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 19V5M5 12l7-7 7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active', sidebar.classList.contains('open'));
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }
        
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.remove('collapsed');
            }
        });
        
        const state = {
            currentProjectId: null,
            currentProjectName: null,
            currentMode: null,
            qualityTier: 'good',
            videoDuration: 30,
            messages: [],
            selectedOverlays: [],
            overlayTemplates: { saved: [], recent: [] },
            currentOverlayTemplateId: null,
            usageData: null,
            projects: [],
            exportCount: {{ export_count }},
            isProcessing: false,
            isGenerating: false
        };
        
        const QUALITY_TIERS = {
            good: {
                name: 'Good',
                model: 'Gen-3 Turbo',
                pricePerThirty: 4.00,
                costPerSecond: 0.05,
                description: 'Fast generation, solid quality for most content'
            },
            better: {
                name: 'Better',
                model: 'Gen-4 Turbo',
                pricePerThirty: 6.00,
                costPerSecond: 0.10,
                description: 'Enhanced detail and motion consistency'
            },
            best: {
                name: 'Best',
                model: 'Gen-4 Aleph',
                pricePerThirty: 8.00,
                costPerSecond: 0.15,
                description: 'Cinema-grade output with maximum fidelity'
            }
        };
        
        const QUALITY_DISCLAIMER = "Quality tier affects visual generation only. It won't change your video's direction, pacing, or message  just how sharp and polished the final output looks.";
        
        function startNewProject() {
            state.currentProjectId = null;
            state.currentProjectName = null;
            state.currentMode = null;
            state.messages = [];
            state.briefFiles = [];
            document.getElementById('current-project-title').textContent = '';
            document.getElementById('project-name-text').textContent = 'Untitled Project';
            document.getElementById('chat-welcome').style.display = 'flex';
            document.getElementById('chat-messages').classList.remove('active');
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('brief-textarea').value = '';
            document.getElementById('uploaded-files-preview').style.display = 'none';
            document.getElementById('uploaded-files-preview').innerHTML = '';
            updateBriefGoBtn();
            document.querySelectorAll('.project-card').forEach(c => c.classList.remove('active'));
        }
        
        state.briefFiles = [];

        function updateBriefGoBtn() {
            const text = document.getElementById('brief-textarea').value.trim();
            document.getElementById('brief-go-btn').disabled = !text && state.briefFiles.length === 0;
        }

        function handleBriefFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                state.briefFiles.push({ file, mode: 'clip', id: Date.now() + Math.random() });
            });
            renderBriefFiles();
            updateBriefGoBtn();
            event.target.value = '';
        }

        function renderBriefFiles() {
            const container = document.getElementById('uploaded-files-preview');
            if (state.briefFiles.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'flex';
            container.innerHTML = state.briefFiles.map((f, i) => `
                <div class="uploaded-file-chip">
                    <span>${f.file.name.length > 20 ? f.file.name.substring(0, 17) + '...' : f.file.name}</span>
                    <div class="file-mode-toggle">
                        <button class="file-mode-btn ${f.mode === 'clip' ? 'active' : ''}" onclick="setFileMode(${i}, 'clip')">Clip</button>
                        <button class="file-mode-btn ${f.mode === 'remix' ? 'active' : ''}" onclick="setFileMode(${i}, 'remix')">Remix</button>
                    </div>
                    <button class="file-remove-btn" onclick="removeBriefFile(${i})">&times;</button>
                </div>
            `).join('');
        }

        function setFileMode(index, mode) {
            state.briefFiles[index].mode = mode;
            renderBriefFiles();
        }

        function removeBriefFile(index) {
            state.briefFiles.splice(index, 1);
            renderBriefFiles();
            updateBriefGoBtn();
        }

        function transitionToChat() {
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('chat-messages').classList.add('active');
            document.getElementById('chat-input-area').style.display = 'block';
            setTimeout(() => {
                document.getElementById('chat-input').focus();
            }, 100);
        }

        function submitBrief() {
            const briefText = document.getElementById('brief-textarea').value.trim();
            if (!briefText && state.briefFiles.length === 0) return;

            transitionToChat();

            let briefMessage = briefText;
            if (state.briefFiles.length > 0) {
                const fileList = state.briefFiles.map(f => `${f.file.name} (${f.mode})`).join(', ');
                briefMessage += briefText ? `\n\nUploaded: ${fileList}` : `Uploaded: ${fileList}`;

                if (!state.briefFiles.some(f => f.mode)) {
                    addAIMessage("I see you've uploaded videos. For each one, would you like me to **Clip** the best moments or **Remix** it with new visuals? You can set this per video above.");
                    return;
                }
            }

            if (briefText) {
                addUserMessage(briefMessage);
                sendMessage(briefMessage);
            } else if (state.briefFiles.length > 0) {
                const noUploadMsg = `I've uploaded ${state.briefFiles.length} video${state.briefFiles.length > 1 ? 's' : ''}. ${state.briefFiles.map(f => f.file.name + ' (' + f.mode + ')').join(', ')}`;
                addUserMessage(noUploadMsg);
                sendMessage(noUploadMsg);
            }
        }

        function selectMode(mode) {
            state.currentMode = mode;
            
            transitionToChat();
            
            if (mode === 'remix') {
                addAIMessageWithQualitySelector();
            } else {
                const modeDescriptions = {
                    clipper: "You want to clip videos. Upload your video and I'll pull the best moments from the transcript.\n\nYou can also add overlays  captions, logos, lower thirds, or any of the 7 element types. I'll suggest what might work, but you always decide.\n\nWhat would you like to clip?",
                    simple: "You want to create from scratch using stock footage and AI visuals. Just describe what you're going for and I'll build it.\n\nWhat's your idea?"
                };
                addAIMessage(modeDescriptions[mode]);
            }
        }
        
        function addAIMessageWithQualitySelector() {
            const container = document.getElementById('chat-messages');
            const msgEl = document.createElement('div');
            msgEl.className = 'message message-ai';
            
            const qualityCardsHtml = Object.entries(QUALITY_TIERS).map(([key, tier]) => `
                <div class="quality-card ${key === state.qualityTier ? 'selected' : ''}" onclick="selectQualityTier('${key}')">
                    <div class="quality-tier-name">${tier.name}</div>
                    <div class="quality-tier-model">${tier.model}</div>
                    <div class="quality-tier-price">$${tier.pricePerThirty.toFixed(2)}<span class="quality-tier-unit">/30s</span></div>
                    <div class="quality-tier-desc">${tier.description}</div>
                </div>
            `).join('');
            
            msgEl.innerHTML = `
                <div class="message-ai-avatar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                </div>
                <div class="message-ai-content">
                    <p>You selected <strong>Remix mode</strong>. First, choose your quality tier:</p>
                    
                    <div class="quality-selector">
                        <div class="quality-selector-title">Select Video Quality</div>
                        <div class="quality-cards" id="quality-cards">
                            ${qualityCardsHtml}
                        </div>
                        <div class="quality-disclaimer">${QUALITY_DISCLAIMER}</div>
                        <div class="quality-cost-estimate">
                            <span class="cost-label">Estimated cost for 30s video:</span>
                            <span class="cost-value" id="quality-cost-estimate">$${calculateCostEstimate(30).toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <p style="margin-top: 16px;">Upload a reference video for the vibe you want, then tell me what content to create. I'll preserve the motion and structure while transforming the visuals.</p>
                </div>
            `;
            
            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;
        }
        
        function selectQualityTier(tier) {
            state.qualityTier = tier;
            document.querySelectorAll('.quality-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            updateCostEstimate();
        }
        
        function calculateCostEstimate(durationSeconds) {
            const tier = QUALITY_TIERS[state.qualityTier];
            const runwayCost = tier.costPerSecond * durationSeconds;
            const shotstackCost = 0.20 * (durationSeconds / 30);
            const claudeCost = 0.50;
            const elevenLabsCost = 0.30;
            const stockCost = 0.10;
            return runwayCost + shotstackCost + claudeCost + elevenLabsCost + stockCost;
        }
        
        function updateCostEstimate() {
            const costEl = document.getElementById('quality-cost-estimate');
            if (costEl) {
                costEl.textContent = '$' + calculateCostEstimate(state.videoDuration).toFixed(2);
            }
        }
        
        function showToast(title, message, action = null, actionLabel = 'View', autoClose = true) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            
            const actionHtml = action ? `<button class="toast-action" onclick="(${action})(); this.closest('.toast').remove();">${actionLabel}</button>` : '';
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                ${actionHtml}
                <button class="toast-close" onclick="this.closest('.toast').remove()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            
            container.appendChild(toast);
            
            if (autoClose) {
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.style.animation = 'slideIn 0.3s ease reverse';
                        setTimeout(() => toast.remove(), 300);
                    }
                }, 8000);
            }
            
            return toast;
        }
        
        function showGeneratingSpinner(projectId) {
            const card = document.querySelector(`[data-project-id="${projectId}"]`);
            if (card && !card.querySelector('.project-generating-spinner')) {
                const spinner = document.createElement('div');
                spinner.className = 'project-generating-spinner';
                card.appendChild(spinner);
            }
        }
        
        function hideGeneratingSpinner(projectId) {
            const card = document.querySelector(`[data-project-id="${projectId}"]`);
            if (card) {
                const spinner = card.querySelector('.project-generating-spinner');
                if (spinner) spinner.remove();
            }
        }
        
        function setGeneratingState(isGenerating, projectId = null) {
            state.isGenerating = isGenerating;
            if (projectId) {
                if (isGenerating) {
                    showGeneratingSpinner(projectId);
                } else {
                    hideGeneratingSpinner(projectId);
                }
            }
        }
        
        function onVideoGenerationComplete(projectId, videoUrl) {
            setGeneratingState(false, projectId);
            showToast(
                'Video Ready!',
                'Your video has been generated successfully.',
                `function() { window.location.href = '/project/${projectId}'; }`,
                'View',
                false
            );
        }
        
        function showProgressMessage(sceneNum, totalScenes, estimatedMinutes) {
            const progressText = `Generating scene ${sceneNum} of ${totalScenes}... ${estimatedMinutes > 0 ? `~${estimatedMinutes} min remaining` : 'Almost done'}`;
            return progressText;
        }
        
        const activeJobPolls = new Map();
        
        async function createVideoJob(projectId, qualityTier, jobData) {
            try {
                const response = await fetch('/api/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        project_id: projectId,
                        quality_tier: qualityTier,
                        job_data: jobData
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    setGeneratingState(true, projectId);
                    startJobPolling(data.job.id, projectId);
                    addAIMessage(`Video generation started! You can continue working while it processes. Quality: ${QUALITY_TIERS[qualityTier].name}`);
                    return data.job;
                } else {
                    addAIMessage(`Failed to start generation: ${data.error}`);
                    return null;
                }
            } catch (err) {
                console.error('Failed to create job:', err);
                addAIMessage('Something went wrong. Please try again.');
                return null;
            }
        }
        
        function startJobPolling(jobId, projectId) {
            if (activeJobPolls.has(jobId)) return;
            
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/jobs/${jobId}`);
                    const data = await response.json();
                    
                    if (!data.ok) {
                        clearInterval(pollInterval);
                        activeJobPolls.delete(jobId);
                        return;
                    }
                    
                    const job = data.job;
                    
                    if (job.status === 'completed') {
                        clearInterval(pollInterval);
                        activeJobPolls.delete(jobId);
                        onVideoGenerationComplete(projectId, job.result_url);
                    } else if (job.status === 'failed') {
                        clearInterval(pollInterval);
                        activeJobPolls.delete(jobId);
                        setGeneratingState(false, projectId);
                        showToast('Generation Failed', job.error_message || 'Please try again.', null, null, true);
                    } else if (job.status === 'processing') {
                        const progress = job.progress;
                        if (progress && progress.message) {
                            updateProgressDisplay(projectId, progress.current, progress.total, progress.message);
                        }
                    }
                } catch (err) {
                    console.error('Job polling error:', err);
                }
            }, 3000);
            
            activeJobPolls.set(jobId, pollInterval);
        }
        
        function updateProgressDisplay(projectId, current, total, message) {
            const card = document.querySelector(`[data-project-id="${projectId}"]`);
            if (card) {
                let progressEl = card.querySelector('.project-progress-text');
                if (!progressEl) {
                    progressEl = document.createElement('div');
                    progressEl.className = 'project-progress-text';
                    progressEl.style.cssText = 'font-size: 10px; color: var(--text-dim); margin-top: 2px;';
                    card.querySelector('.project-info')?.appendChild(progressEl);
                }
                progressEl.textContent = message || `${current}/${total}`;
            }
        }
        
        async function checkActiveJobs() {
            try {
                const response = await fetch('/api/jobs?active=true');
                const data = await response.json();
                
                if (data.ok && data.jobs.length > 0) {
                    data.jobs.forEach(job => {
                        if (!activeJobPolls.has(job.id)) {
                            setGeneratingState(true, job.project_id);
                            startJobPolling(job.id, job.project_id);
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to check active jobs:', err);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkActiveJobs, 1000);
        });
        
        function selectProject(projectId) {
            state.currentProjectId = projectId;
            document.querySelectorAll('.project-card').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-project-id="${projectId}"]`)?.classList.add('active');
            
            loadProjectChat(projectId);
        }
        
        async function loadProjectChat(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}/chat`);
                const data = await response.json();
                
                if (data.ok) {
                    state.messages = data.messages || [];
                    state.currentMode = data.mode;
                    state.currentProjectName = data.name || 'Untitled Project';
                    document.getElementById('current-project-title').textContent = data.name;
                    document.getElementById('project-name-text').textContent = state.currentProjectName;
                    transitionToChat();
                    renderMessages();
                }
            } catch (err) {
                console.error('Failed to load project chat:', err);
            }
        }
        
        function startProjectRename() {
            if (!state.currentProjectId) return;
            
            const container = document.getElementById('project-name-edit');
            const currentName = state.currentProjectName || 'Untitled Project';
            
            container.innerHTML = `<input type="text" class="project-name-input" id="project-name-input" value="${escapeHtml(currentName)}" onblur="finishProjectRename()" onkeydown="if(event.key==='Enter')finishProjectRename();if(event.key==='Escape')cancelProjectRename();">`;
            
            const input = document.getElementById('project-name-input');
            input.focus();
            input.select();
        }
        
        async function finishProjectRename() {
            const input = document.getElementById('project-name-input');
            if (!input) return;
            
            const newName = input.value.trim() || 'Untitled Project';
            
            if (state.currentProjectId && newName !== state.currentProjectName) {
                try {
                    const response = await fetch(`/api/project/${state.currentProjectId}/rename`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: newName })
                    });
                    
                    const data = await response.json();
                    if (data.ok) {
                        state.currentProjectName = newName;
                        loadProjects();
                    }
                } catch (err) {
                    console.error('Failed to rename project:', err);
                }
            }
            
            restoreProjectNameDisplay(newName);
        }
        
        function cancelProjectRename() {
            restoreProjectNameDisplay(state.currentProjectName || 'Untitled Project');
        }
        
        function restoreProjectNameDisplay(name) {
            const container = document.getElementById('project-name-edit');
            container.innerHTML = `
                <span class="project-name-text" id="project-name-text">${escapeHtml(name)}</span>
                <svg class="project-name-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            `;
        }
        
        function renderMessages() {
            const container = document.getElementById('chat-messages');
            container.innerHTML = state.messages.map(msg => {
                if (msg.role === 'user') {
                    return `<div class="message message-user">
                        <div class="message-content">
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>`;
                } else {
                    return `<div class="message message-ai">
                        <div class="message-ai-avatar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#0d0d0d" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                            </svg>
                        </div>
                        <div class="message-content">
                            <div class="message-text">${formatAIMessage(msg.content)}</div>
                        </div>
                    </div>`;
                }
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatAIMessage(text) {
            return escapeHtml(text).replace(/\n/g, '<br>');
        }
        
        function addUserMessage(text) {
            state.messages.push({ role: 'user', content: text });
            renderMessages();
        }
        
        function addAIMessage(text) {
            state.messages.push({ role: 'assistant', content: text });
            renderMessages();
        }
        
        async function sendMessage(messageOverride) {
            const input = document.getElementById('chat-input');
            let text;
            if (messageOverride) {
                text = messageOverride;
            } else {
                text = input.value.trim();
                if (!text) return;
                input.value = '';
                autoResize(input);
                addUserMessage(text);
            }
            
            if (!state.currentMode && !state.currentProjectId) {
                state.currentMode = 'auto';
            }
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: text,
                        project_id: state.currentProjectId,
                        mode: state.currentMode
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    if (data.project_id && !state.currentProjectId) {
                        state.currentProjectId = data.project_id;
                        state.currentProjectName = data.project_name || 'New Project';
                        document.getElementById('current-project-title').textContent = state.currentProjectName;
                        document.getElementById('project-name-text').textContent = state.currentProjectName;
                        loadProjects();
                        
                        if (state.briefFiles.length > 0) {
                            uploadBriefFiles();
                        }
                    }
                    
                    if (data.response) {
                        addAIMessage(data.response);
                    }
                    
                    if (data.needs_clarification) {
                        addAIMessage(data.clarification_question);
                    }
                    
                    if (data.scene_plan && data.scene_plan.length > 0) {
                        renderScenePlan(data.scene_plan, data.total_cost, data.cost_breakdown);
                    }
                    
                    if (data.trigger_generation && data.job_data) {
                        const selectedTier = state.selectedQualityTier || 'good';
                        createVideoJob(state.currentProjectId, selectedTier, data.job_data);
                    }
                    
                    if (data.processing) {
                        showProcessingBanner(data.job_id);
                    }
                } else {
                    addAIMessage("I encountered an issue. " + (data.error || "Please try again."));
                }
            } catch (err) {
                addAIMessage("Connection error. Please check your network and try again.");
            }
        }
        
        function handleInputKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }
        
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                
                if (data.ok) {
                    state.projects = data.projects || [];
                    renderProjects();
                    updateAutoGenStatus();
                }
            } catch (err) {
                console.error('Failed to load projects:', err);
            }
        }
        
        function renderProjects() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const weekAgo = new Date(today);
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const todayProjects = [];
            const yesterdayProjects = [];
            const olderProjects = [];
            
            state.projects.forEach(project => {
                const projectDate = new Date(project.created_at);
                projectDate.setHours(0, 0, 0, 0);
                
                if (projectDate >= today) {
                    todayProjects.push(project);
                } else if (projectDate >= yesterday) {
                    yesterdayProjects.push(project);
                } else if (projectDate >= weekAgo) {
                    olderProjects.push(project);
                }
            });
            
            document.getElementById('today-list').innerHTML = renderProjectList(todayProjects);
            document.getElementById('yesterday-list').innerHTML = renderProjectList(yesterdayProjects);
            document.getElementById('older-list').innerHTML = renderProjectList(olderProjects);
            
            document.getElementById('today-projects').style.display = todayProjects.length ? 'block' : 'none';
            document.getElementById('yesterday-projects').style.display = yesterdayProjects.length ? 'block' : 'none';
            document.getElementById('older-projects').style.display = olderProjects.length ? 'block' : 'none';
        }
        
        function renderProjectList(projects) {
            return projects.map(p => `
                <div class="project-card ${state.currentProjectId === p.id ? 'active' : ''}" 
                     data-project-id="${p.id}"
                     onclick="selectProject(${p.id})">
                    <div class="project-thumb">
                        ${p.thumbnail ? `<img src="${p.thumbnail}" alt="">` : p.name.charAt(0).toUpperCase()}
                    </div>
                    <div class="project-info">
                        <div class="project-name">${escapeHtml(p.name)}</div>
                        <div class="project-meta">${p.duration || '0'}s  ${p.mode || 'Draft'}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateAutoGenStatus() {
            const count = state.exportCount;
            const unlocked = count >= 5;
            
            document.getElementById('auto-gen-count').textContent = `${Math.min(count, 5)}/5`;
            document.getElementById('auto-gen-bar').style.width = `${Math.min(count, 5) * 20}%`;
            
            const btn = document.getElementById('auto-gen-btn');
            const btnText = document.getElementById('auto-gen-btn-text');
            
            if (unlocked) {
                btn.classList.add('unlocked');
                btnText.textContent = 'CHECK PREVIEWS';
            } else {
                btn.classList.remove('unlocked');
                btnText.textContent = 'LOCKED';
            }
        }
        
        function openAutoGenerator() {
            if (state.exportCount >= 5) {
                window.location.href = '/auto-generator';
            }
        }
        
        function showProcessingBanner(jobId) {
            state.isProcessing = true;
            document.getElementById('processing-banner').classList.add('active');
            pollJobStatus(jobId);
        }
        
        async function pollJobStatus(jobId) {
            try {
                const response = await fetch(`/api/job/${jobId}/status`);
                const data = await response.json();
                
                if (data.status === 'complete') {
                    document.getElementById('processing-banner').classList.remove('active');
                    state.isProcessing = false;
                    addAIMessage("Your video is ready! You can preview it now or export the final version.");
                } else if (data.status === 'error') {
                    document.getElementById('processing-banner').classList.remove('active');
                    state.isProcessing = false;
                    addAIMessage("There was an issue creating your video. Let me try a different approach.");
                } else {
                    document.getElementById('processing-fill').style.width = `${data.progress || 0}%`;
                    document.getElementById('processing-text').textContent = data.message || 'Processing...';
                    setTimeout(() => pollJobStatus(jobId), 2000);
                }
            } catch (err) {
                console.error('Failed to poll job status:', err);
            }
        }
        
        function closeAndNotify() {
            addAIMessage("I'll email you when your video is ready. You can close this tab now.");
            document.getElementById('processing-banner').classList.remove('active');
        }
        
        function keepWatching() {
            document.getElementById('processing-banner').classList.remove('active');
        }
        
        function toggleUserMenu() {
            // User profile menu - show logout option
            if (confirm('Log out of Framd?')) {
                window.location.href = '/logout';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            updateAutoGenStatus();
            setupDragAndDrop();
        });
        
        // File drag and drop anywhere on page
        function setupDragAndDrop() {
            const overlay = document.getElementById('dropzone-overlay');
            let dragCounter = 0;
            
            document.addEventListener('dragenter', (e) => {
                e.preventDefault();
                dragCounter++;
                if (e.dataTransfer.types.includes('Files')) {
                    overlay.classList.add('active');
                }
            });
            
            document.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dragCounter--;
                if (dragCounter === 0) {
                    overlay.classList.remove('active');
                }
            });
            
            document.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            document.addEventListener('drop', (e) => {
                e.preventDefault();
                dragCounter = 0;
                overlay.classList.remove('active');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleDroppedFile(files[0]);
                }
            });
        }
        
        async function handleDroppedFile(file) {
            const validTypes = ['video/', 'audio/', 'image/'];
            const isValid = validTypes.some(type => file.type.startsWith(type));
            
            if (!isValid) {
                addAIMessage("I can only accept video, audio, or image files. Please try a different file.");
                return;
            }
            
            // Show the chat area if not visible
            document.getElementById('chat-welcome').style.display = 'none';
            document.getElementById('chat-messages').classList.add('active');
            
            // Add user message about the file
            const fileType = file.type.split('/')[0];
            addUserMessage(`[Uploaded ${fileType}: ${file.name}]`);
            
            // Upload the file
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                addAIMessage("Uploading your file...");
                
                const response = await fetch('/upload-media', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Remove the "uploading" message
                    const messages = document.getElementById('chat-messages');
                    if (messages.lastChild) {
                        messages.removeChild(messages.lastChild);
                    }
                    
                    if (data.transcript) {
                        addAIMessage(`Got it! I've analyzed your ${fileType}. What would you like me to create from this?`);
                    } else {
                        addAIMessage(`I've received your ${fileType}. What would you like me to do with it?`);
                    }
                    
                    // Store the file info in state
                    state.uploadedFile = data;
                } else {
                    addAIMessage("There was an issue uploading your file. Please try again.");
                }
            } catch (err) {
                console.error('Upload error:', err);
                addAIMessage("Upload failed. Please check your connection and try again.");
            }
        }

        const OVERLAY_ELEMENT_TYPES = [
            { type: 'caption', label: 'Captions', icon: '', cost: 0.20, description: 'Word-synced captions from audio' },
            { type: 'logo', label: 'Logo', icon: '', cost: 0.10, description: 'Upload and position your logo' },
            { type: 'lower_third', label: 'Lower Third', icon: '', cost: 0.15, description: 'Name/title bar that slides in' },
            { type: 'text', label: 'Text', icon: '', cost: 0.05, description: 'Custom styled text overlay' },
            { type: 'watermark', label: 'Watermark', icon: '', cost: 0.05, description: 'Semi-transparent branding' },
            { type: 'progress_bar', label: 'Progress', icon: '', cost: 0.10, description: 'Video progress indicator' },
            { type: 'cta', label: 'CTA', icon: '', cost: 0.10, description: 'Call-to-action banner' },
        ];

        function initOverlayPanel() {
            const grid = document.getElementById('overlay-elements-grid');
            if (!grid) return;
            grid.innerHTML = OVERLAY_ELEMENT_TYPES.map(el => `
                <div class="overlay-element-card" data-type="${el.type}" onclick="toggleOverlayElement('${el.type}')">
                    <div class="overlay-element-icon">${el.icon}</div>
                    <div class="overlay-element-label">${el.label}</div>
                    <div class="overlay-element-cost">+$${el.cost.toFixed(2)}</div>
                </div>
            `).join('');
        }

        function toggleOverlayPanel() {
            const panel = document.getElementById('overlay-panel');
            if (!panel) return;
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                initOverlayPanel();
                loadOverlayTemplates();
                loadUsageData();
            }
        }

        function toggleOverlayElement(type) {
            const idx = state.selectedOverlays.indexOf(type);
            if (idx > -1) {
                state.selectedOverlays.splice(idx, 1);
            } else {
                state.selectedOverlays.push(type);
            }
            document.querySelectorAll('.overlay-element-card').forEach(card => {
                card.classList.toggle('selected', state.selectedOverlays.includes(card.dataset.type));
            });
            updateOverlayPrice();
        }

        function updateOverlayPrice() {
            let price = 0.49;
            state.selectedOverlays.forEach(type => {
                const el = OVERLAY_ELEMENT_TYPES.find(e => e.type === type);
                if (el) price += el.cost;
            });
            price = Math.min(price, 1.49);

            const priceEl = document.getElementById('overlay-price');
            if (priceEl) {
                if (state.usageData && state.usageData.cap_reached) {
                    priceEl.textContent = 'FREE';
                    priceEl.classList.add('free');
                } else {
                    priceEl.textContent = `$${price.toFixed(2)}`;
                    priceEl.classList.remove('free');
                }
            }
        }

        async function loadOverlayTemplates() {
            try {
                const res = await fetch('/api/overlays/templates');
                const data = await res.json();
                if (data.ok) {
                    state.overlayTemplates = { saved: data.saved, recent: data.recent };
                    renderOverlayTemplates();
                }
            } catch (e) { console.error('Failed to load overlay templates:', e); }
        }

        function renderOverlayTemplates() {
            const savedSection = document.getElementById('overlay-templates-section');
            const recentSection = document.getElementById('overlay-recent-section');
            const savedChips = document.getElementById('saved-template-chips');
            const recentChips = document.getElementById('recent-template-chips');

            if (state.overlayTemplates.saved.length > 0) {
                savedSection.style.display = 'block';
                savedChips.innerHTML = state.overlayTemplates.saved.map(t => `
                    <div class="overlay-template-chip" onclick="applyTemplate(${t.id})">
                        ${t.name}<span class="chip-count">${t.elements.length} elements</span>
                    </div>
                `).join('');
            } else {
                savedSection.style.display = 'none';
            }

            if (state.overlayTemplates.recent.length > 0) {
                recentSection.style.display = 'block';
                recentChips.innerHTML = state.overlayTemplates.recent.map(t => `
                    <div class="overlay-template-chip" onclick="applyTemplate(${t.id})">
                        ${t.name}<span class="chip-count">${t.elements.length} elements</span>
                    </div>
                `).join('');
            } else {
                recentSection.style.display = 'none';
            }
        }

        async function loadUsageData() {
            try {
                const res = await fetch('/api/overlays/usage');
                const data = await res.json();
                if (data.ok) {
                    state.usageData = data;
                    const bar = document.getElementById('usage-bar');
                    const text = document.getElementById('usage-text');
                    const fill = document.getElementById('usage-progress-fill');
                    if (bar && text && fill) {
                        bar.style.display = 'block';
                        if (data.cap_reached) {
                            text.textContent = `Monthly cap reached  all clips are FREE this month (${data.clip_count} clips made)`;
                        } else {
                            text.textContent = `$${data.spent.toFixed(2)} / $${data.cap.toFixed(2)} this month (${data.clip_count} clips)`;
                        }
                        fill.style.width = `${data.cap_progress}%`;
                    }
                    updateOverlayPrice();
                }
            } catch (e) { console.error('Failed to load usage data:', e); }
        }

        async function applyTemplate(templateId) {
            try {
                const res = await fetch(`/api/overlays/templates/${templateId}`);
                const data = await res.json();
                if (data.ok && data.template) {
                    state.selectedOverlays = data.template.elements.map(e => e.element_type);
                    state.currentOverlayTemplateId = templateId;
                    document.querySelectorAll('.overlay-element-card').forEach(card => {
                        card.classList.toggle('selected', state.selectedOverlays.includes(card.dataset.type));
                    });
                    updateOverlayPrice();
                    addAIMessage(`Applied "${data.template.name}" template with ${data.template.elements.length} overlay elements. You can adjust any of them before applying.`);
                }
            } catch (e) { console.error('Failed to apply template:', e); }
        }

        async function saveOverlayTemplate() {
            if (state.selectedOverlays.length === 0) {
                addAIMessage("Select at least one overlay element to save as a template.");
                return;
            }
            const name = prompt('Name your overlay template:');
            if (!name) return;

            try {
                const res = await fetch('/api/overlays/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        is_permanent: false,
                        elements: state.selectedOverlays.map((type, i) => ({
                            element_type: type,
                            layer_order: i,
                            position: {},
                            style: {},
                            content: {},
                        })),
                    }),
                });
                const data = await res.json();
                if (data.ok) {
                    state.currentOverlayTemplateId = data.template.id;
                    addAIMessage(`Saved "${name}" as a recent overlay template. You can promote it to a permanent template to use across all projects.`);
                    loadOverlayTemplates();
                }
            } catch (e) { console.error('Failed to save template:', e); }
        }

        async function promoteOverlayTemplate() {
            if (!state.currentOverlayTemplateId) {
                addAIMessage("Save an overlay template first, then you can make it permanent.");
                return;
            }
            try {
                const res = await fetch(`/api/overlays/templates/${state.currentOverlayTemplateId}/promote`, { method: 'POST' });
                const data = await res.json();
                if (data.ok) {
                    addAIMessage(`"${data.template.name}" is now a permanent template  it'll be available across all your projects.`);
                    loadOverlayTemplates();
                }
            } catch (e) { console.error('Failed to promote template:', e); }
        }

        async function applyOverlays() {
            if (!state.currentProjectId) {
                addAIMessage("Start a project first, then you can apply overlays.");
                return;
            }
            if (state.selectedOverlays.length === 0) {
                toggleOverlayPanel();
                return;
            }
            try {
                const res = await fetch(`/api/projects/${state.currentProjectId}/overlays`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_id: state.currentOverlayTemplateId,
                        overlay_config: {
                            elements: state.selectedOverlays.map((type, i) => ({
                                element_type: type,
                                layer_order: i,
                            })),
                        },
                    }),
                });
                const data = await res.json();
                if (data.ok) {
                    const overlayNames = state.selectedOverlays.map(t => {
                        const el = OVERLAY_ELEMENT_TYPES.find(e => e.type === t);
                        return el ? el.label : t;
                    }).join(', ');
                    addAIMessage(`Applied overlays: ${overlayNames}. These will be saved with this project for next time.`);
                    toggleOverlayPanel();
                    loadUsageData();
                }
            } catch (e) { console.error('Failed to apply overlays:', e); }
        }

        function renderScenePlan(scenes, totalCost, breakdown) {
            const container = document.getElementById('chat-messages');
            const msgEl = document.createElement('div');
            msgEl.className = 'message message-ai';

            const sourceColors = { clip: '#4ade80', stock: '#60a5fa', dalle: '#c084fc', remix: '#fb923c' };
            const totalDuration = scenes.reduce((sum, s) => sum + (s.duration || 0), 0);

            const scenesHtml = scenes.map((s, i) => `
                <div class="scene-item">
                    <div class="scene-index">${i + 1}</div>
                    <div class="scene-details">
                        <div class="scene-text">${escapeHtml(s.script_text || s.content_description || 'Scene ' + (i + 1))}</div>
                        <div class="scene-meta">
                            <span class="scene-tag source-${s.source_type}">${s.source_type}</span>
                            <span class="scene-tag">${s.visual_container || 'fullscreen'}</span>
                            <span class="scene-tag">${(s.duration || 0).toFixed(1)}s</span>
                        </div>
                    </div>
                    <div class="scene-cost">$${(s.estimated_cost || 0).toFixed(2)}</div>
                </div>
            `).join('');

            const breakdownHtml = breakdown ? Object.entries(breakdown).map(([k, v]) =>
                `<span>${k}: $${v.toFixed(2)}</span>`
            ).join('  ') : '';

            msgEl.innerHTML = `
                <div class="message-ai-avatar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                    </svg>
                </div>
                <div class="message-ai-content">
                    <div class="scene-plan-card">
                        <div class="scene-plan-header">
                            <div class="scene-plan-title">Scene Plan</div>
                            <div class="scene-plan-count">${scenes.length} scenes  ${totalDuration.toFixed(1)}s</div>
                        </div>
                        <div class="scene-list">${scenesHtml}</div>
                        <div class="cost-summary">
                            <div>
                                <div class="cost-total">$${(totalCost || 0).toFixed(2)}</div>
                                <div class="cost-breakdown">${breakdownHtml}</div>
                            </div>
                            <div>
                                <button class="revise-btn" onclick="requestScenePlanRevision()">Needs changes</button>
                                <button class="approve-btn" onclick="approveScenePlan()">Approve & Generate</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(msgEl);
            container.scrollTop = container.scrollHeight;
            state.currentScenePlan = scenes;
        }

        function approveScenePlan() {
            if (!state.currentProjectId) return;
            addUserMessage("Approved  let's generate this.");
            sendMessage("I approve the scene plan. Generate the video.");
        }

        function requestScenePlanRevision() {
            addUserMessage("I'd like to change some things in the scene plan.");
            sendMessage("I want to revise the scene plan. What would you like me to change?");
        }

        async function uploadBriefFiles() {
            if (!state.currentProjectId || state.briefFiles.length === 0) return;

            for (const bf of state.briefFiles) {
                const formData = new FormData();
                formData.append('file', bf.file);
                formData.append('project_id', state.currentProjectId);
                formData.append('processing_mode', bf.mode);

                try {
                    const res = await fetch('/api/pipeline/upload-source', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();
                    if (data.ok && data.source && data.source.id) {
                        await fetch('/api/pipeline/process-source', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ source_id: data.source.id })
                        });
                    }
                } catch (err) {
                    console.error('Failed to upload source:', err);
                }
            }
            state.briefFiles = [];
        }

        function showOverlayPanelForClipper() {
            if (state.currentMode === 'clipper') {
                const panel = document.getElementById('overlay-panel');
                if (panel && !panel.classList.contains('active')) {
                    toggleOverlayPanel();
                }
            }
        }

    </script>
</body>
</html>
